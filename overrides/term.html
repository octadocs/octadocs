{% extends "base.html" %}

{% block content %}
{% set headers = query(
    'SELECT ?label WHERE {
        ?entity rdfs:isDefinedBy ?iri .

        OPTIONAL {
            GRAPH ?iri {
                ?entity rdfs:label ?readable_label .
            }
        }

        OPTIONAL {
            GRAPH <local:rdfs/rdfs.n3> {
                ?entity rdfs:label ?default_label .
            }
        }

        BIND(COALESCE(?readable_label, ?default_label) AS ?label)
    }',
    iri=iri,
) %}

{% set summaries = query('
    SELECT ?summary WHERE {
        ?term rdfs:isDefinedBy ?iri .

        GRAPH ?iri {
            OPTIONAL {
                ?term rdfs:comment ?readable_summary .
            }
        }

        GRAPH <local:rdfs/rdfs.n3> {
            ?term rdfs:comment ?default_summary .
        }

        BIND(COALESCE(?readable_summary, ?default_summary) AS ?summary)
    }
', iri=iri) %}

{% if headers %}
<h1 class="ui header">
    {{ headers.0.label }}
    {% if summaries %}
        <div class="sub header">
            {{ summaries.0.summary }}
        </div>
    {% endif %}
</h1>
{% else %}
# Page title is not available ðŸ˜Ÿ
{% endif %}

{% set superclasses = query('
    SELECT ?link ?label ?link WHERE {
        ?term rdfs:isDefinedBy ?iri .
        ?term rdfs:subClassOf ?superclass .
        ?superclass rdfs:isDefinedBy/octa:url ?link .
        ?superclass rdfs:label ?label .
        FILTER(?superclass != ?term)
    }
', iri=iri) %}


{% set classes = query('
    SELECT ?link ?label WHERE {
        ?term rdfs:isDefinedBy ?iri .

        GRAPH <local:rdfs/rdfs.n3> {
            ?term a ?class .
        }

        ?class rdfs:label ?label .

        OPTIONAL {
            ?class rdfs:isDefinedBy/octa:url ?link .
        }
    }
', iri=iri) %}

{% set related_objects_query = '
    SELECT ?link ?label WHERE {
        ?term rdfs:isDefinedBy ?iri .

        GRAPH <local:rdfs/rdfs.n3> {
            ?term ?relation ?related_object .
        }

        ?related_object rdfs:label ?label .

        OPTIONAL {
            ?related_object rdfs:isDefinedBy ?page .
            ?page a octa:Page .
            ?page octa:url ?link .
        }
    }
' %}

{% set ranges = query(related_objects_query, iri=iri, relation=rdfs.range) %}
{% set domains = query(related_objects_query, iri=iri, relation=rdfs.domain) %}

{% set is_property = query('ASK {
    ?term rdfs:isDefinedBy ?page .
    ?term rdf:type rdf:Property
}', page=iri) %}

<div class="ui relaxed horizontal list">
{% if classes %}
    <div class="item">
        <div class="content">
            <div class="header">Instance of:</div>
            {% for class in classes %}
                {% if class.link %}
                    <a href="/{{ class.link }}">{{ class.label }}</a>{% filter trim %}
                    {% if not loop.last %}, {% endif %}
                    {% endfilter %}
                {% else %}
                    <strong>{{ class.label }}</strong>{% filter trim %}
                    {% if not loop.last %}, {% endif %}
                    {% endfilter %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endif %}

{% if superclasses %}
    <div class="item">
        <div class="content">
            <div class="header">Subclass of:</div>
            {% for superclass in superclasses %}
                {% if superclass.link %}
                    <a href="/{{ superclass.link }}">{{ superclass.label }}</a>{% filter trim %}
                    {% if not loop.last %}, {% endif %}
                    {% endfilter %}
                {% else %}
                    <strong>{{ superclass.label }}</strong>{% filter trim %}
                    {% if not loop.last %}, {% endif %}
                    {% endfilter %}
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endif %}

{% if is_property %}
    <div class="item">
        <div class="content">
            <div class="header">Property:</div>
            {% for domain in domains %}
                {% if domain.link %}
                    <a href="/{{ domain.link }}">{{ domain.label }}</a>
                {% else %}
                    <strong>{{ domain.label }}</strong>
                {% endif %}
                {% if loop.revindex == 2 %} or {% elif not loop.last %}, {% endif %}
            {% endfor %}

            â†’

            {% for range in ranges %}
                {% if range.link %}
                    <a href="/{{ range.link }}">{{ range.label }}</a>
                {% else %}
                    <strong>{{ range.label }}</strong>
                {% endif %}
                {% if loop.revindex == 2 %} or {% elif not loop.last %}, {% endif %}
            {% endfor %}
        </div>
    </div>
{% endif %}
</div>

{{ super() }}
{% endblock %}
